<!DOCTYPE html>
<title></title>
<meta charset="utf-8">
<script src="js/d3.v2.min.js"></script>
<script src="js/underscore.js"></script>
<script src="js/burrow.js"></script>

<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

<style>
  #tree {
    margin: 0 auto;
    text-align: center;
  }

  .node circle {
    fill: steelblue;
    stroke-width: 1.5px;
    stroke: #fff;
  }

  .node {
    font: 10px sans-serif;
    cursor: pointer;
  }

  .link {
    fill: none;
    stroke: #ccc;
    stroke-opacity: 0.6;
    stroke-width: 1.5px;
  }
  .m-dialog {
    width: 30%;
  }
</style>

<body>
  <div id="tree"></div>
  <dialog class="mdl-dialog m-dialog">
    <div class="mdl-dialog__content">
      <p id="m-dialog-content">
        Allowing us to collect data will let us get you the information you want faster.
      </p>
    </div>
    <div class="mdl-dialog__actions">
        <button class="mdl-button mdl-js-button mdl-button--icon close">
            <i class="material-icons">close</i>
          </button>
      <a id="m-dialog-tree" type="button" class="mdl-button" target="_blank">Tree</a>
      <a id="m-dialog-view" type="button" class="mdl-button" target="_blank">View</a>
      <a id="m-dialog-download" type="button" class="mdl-button" target="_blank">Get</a>
    </div>
  </dialog>
</body>
<script>
  /* Reingold-Tilford Tree */

  var diameter = 960;
  var padding = 210;

  var tree = d3.layout.tree()
    .size([360, diameter / 2 - padding])
    .separation(function (a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

  var diagonal = d3.svg.diagonal.radial()
    .projection(function (d) { return [d.y, d.x / 180 * Math.PI]; });

  var svg = d3.select("#tree").append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
    .append("g")
    .attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

  d3.selection.prototype.moveToFront = function () {
    return this.each(function () {
      this.parentNode.appendChild(this);
    });
  };

  d3.tsv("data/maltext-data-2.tsv", function (files) {
    var nested1 = processData(files);
    treemap(nested1);

  });

  function processData(files) {
    files.forEach(function (d) {
      d.size = parseInt(d.size);
      d.keys = d.file
        .split("/");
      d.keys.forEach(function (sect, i) {
        d["section" + i] = sect;
      });
    });

    return burrow(files);
  }

  function treemap(root) {
    var nodes = tree.nodes(root),
      links = tree.links(nodes);

    var link = svg.selectAll(".link")
      .data(links, function (d) { return d.source.name + "-" + d.target.name; })

    link
      .transition()
      .delay(400)
      .duration(600)
      .attr("d", diagonal);

    link
      .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal)
      .style("opacity", 0)
      .transition()
      .duration(300)
      .delay(function (d, i) {
        return 24 * i;
      })
      .style("opacity", 1);

    link.exit()
      .transition()
      .duration(400)
      .style("opacity", 0)
      .delay(400)
      .remove();

    var node = svg.selectAll(".node")
      .moveToFront()
      .data(nodes, function (d) { return d.name + "-" + (d.parent ? d.parent.name : "root"); })

    node.exit()
      .transition()
      .duration(400)
      .style("opacity", 0)
      .delay(400)
      .remove();

    node
      .transition()
      .delay(400)
      .duration(800)
      .attr("transform", function (d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })

    node.selectAll("text")
      .transition()
      .duration(800)
      .attr("font-weight", null)
      .attr("fill", "#555")
      .attr("text-anchor", function (d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", function (d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
      .text(function (d) { return d.name; });

    var g = node
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function (d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
      .on("click", clickNode)
      .on("mouseover", function (d) {
        var thisNode = d3.select(this);

        thisNode.select("text")
          .attr("font-size", "18px")
          .attr("font-weight", 'bold');

        thisNode.select("circle")
          .attr("r", "6");
      })
      .on("mouseout", function () {
        // Remove the info text on mouse out.
        var thisNode = d3.select(this);

        thisNode.select("text")
          .attr("font-size", "10px")
          .attr("font-weight", 'normal');

        thisNode.select("circle")
          .attr("r", "3");
      });

    g.append("circle")
      .attr("r", 3)
      .style("opacity", 0)
      .transition()
      .duration(300)
      .delay(function (d, i) {
        return 24 * i;
      })
      .style("opacity", 1);

    g.append("text")
      .attr("dy", ".31em")
      .attr("font-weight", "normal")
      .attr("fill", "black")
      .attr("text-anchor", function (d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", function (d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
      .text(function (d) { return d.name; })
      .style("opacity", 0)
      .transition()
      .duration(300)
      .delay(function (d, i) {
        return 24 * i;
      })
      .style("opacity", 1);

    var dialog = document.querySelector('dialog');
    var showDialogButton = document.querySelector('#show-dialog');
    if (!dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    dialog.querySelector('.close').addEventListener('click', function () {
      dialog.close();
    });
    dialog.querySelector('#m-dialog-download').addEventListener('click', function () {
      dialog.close();
    });

    // Toggle children on click.
    function clickNode(d) {
      if (d.children.length == 0) {
        var path = "dataset/" + d.parent.name + "/" + d.name;
        $("#m-dialog-content").text(d.name);
        $("#m-dialog-download").attr("href", path);
        $("#m-dialog-view").attr("href", "ex-word-show.html?path=" + path);
        $("#m-dialog-tree").attr("href", "ex-word-tree.html?path=" + path);
        dialog.showModal();
      }
    }

  };

  d3.select(self.frameElement).style("height", diameter + "px");
</script>